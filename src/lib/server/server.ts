import { db } from "./db";
import DefaultSeeds from "../../defaults/seeds.json";
import type { ChatCompletionMessageParam } from "openai/resources/chat/completions.mjs";
import OpenAI from "openai";
import { OPENAI_API_KEY } from "$env/static/private";
import type { Plant } from "../../types";
import { plants } from "./schema";
import { eq } from "drizzle-orm";

export const getAllPlants = async () => {
  const existingPlants = await db.query.plants.findMany({
    with: { parents: true },
  });
  if (existingPlants.length === 0) {
    console.log(
      "No plants in DB, we will attempt to populate with defaults...",
    );
    const newPlants: Plant[] = DefaultSeeds;
    await Promise.all(
      newPlants.map((p) => {
        const { commonName, description, properties, imageUrl } = p;
        console.log("inserting", { commonName });
        return db
          .insert(plants)
          .values({ commonName, description, properties, imageUrl });
      }),
    );
    return await db.query.plants.findMany();
  } else {
    return existingPlants;
  }
};

export const addNew = async (plant: Plant) => {
  console.log("dd new plant", plant, typeof plant);
  if (typeof plant === "string") {
    throw Error("Plant is not an object");
  }
  const { commonName, description, properties, parents } = plant;
  await db
    .insert(plants)
    .values({ commonName, description, properties, parent1, parent2 });
  return plant;
};

export const generate = async (
  prompt: ChatCompletionMessageParam[],
  parents: [Plant, Plant],
) => {
  let offspring: Plant | null = null;

  if (prompt && parents) {
    console.log("Using prompt: ******** \n", prompt);

    const openai = new OpenAI({ apiKey: OPENAI_API_KEY });

    const completion = await openai.chat.completions.create({
      messages: prompt,
      model: "gpt-3.5-turbo",
    });

    console.log("response:", completion.choices);

    for (const res of completion.choices) {
      console.log(JSON.stringify(res));
      const formattedContent = res.message.content || "{}";

      offspring = parseNewPlant(formattedContent, [
        parents[0].id,
        parents[1].id,
      ]);
      if (offspring) {
        console.log("Offspring:", offspring);
      } else {
        throw Error("Oops, couldn't parse the offspring text");
      }
    }
  }

  return offspring;
};

const parseNewPlant = (
  text: string,
  parentIds: [number, number],
): Plant | null => {
  const json = JSON.parse(text);
  if (json["commonName"] && json["description"] && json["properties"]) {
    console.log("JSON appears to have the valid fields");
    return {
      id: 0, // will be autogenerated, anyway
      parent1: parentIds[0],
      parent2: parentIds[1],
      commonName: json["commonName"],
      description: json["description"],
      properties: { ...json["properties"] },
    };
  } else {
    throw Error("Fields missing from: " + JSON.stringify(Object.keys(json)));
  }
};

export const attachImageToPlant = async (id: number, imageUrl: string) => {
  const res = await db
    .update(plants)
    .set({ imageUrl })
    .where(eq(plants.id, id))
    .returning({ updatedId: plants.id });
  console.log("attachImageToPlant", res);
  res.forEach((r) => {
    console.log("updated ID", r.updatedId);
  });
  if (res.length == 0) {
    throw Error("nothing got updated!");
  }
};
